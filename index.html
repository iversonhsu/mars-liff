<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨­å®šæ˜Ÿç›¤è³‡æ–™</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding: 20px; background-color: #f5f5f5; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        label { display: block; margin: 15px 0 5px; color: #666; font-size: 14px; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; margin-top: 30px; background-color: #06c755; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        button:active { background-color: #05b34c; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸ”® é–‹å•Ÿæ‚¨çš„é­”æ³•æ—…ç¨‹</h2>
        
        <label>ğŸ“… å‡ºç”Ÿæ—¥æœŸ</label>
        <input type="date" id="date" required>
        
        <label>â° å‡ºç”Ÿæ™‚é–“</label>
        <input type="time" id="time" required>
        
        <label>ğŸ“ å‡ºç”ŸåŸå¸‚</label>
        <input type="text" id="city" placeholder="ä¾‹å¦‚ï¼šå°åŒ—å¸‚" value="å°åŒ—å¸‚">

        <label>ğŸ‘¤ æ€§åˆ¥</label>
        <select id="gender" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; background: white;">
            <option value="F">å¥³æ€§</option>
            <option value="M">ç”·æ€§</option>
            <option value="U">ä¸é€éœ²</option>
        </select>

        <button id="btn" onclick="send()">ç¢ºèªé€å‡º</button>
    </div>

    <script>
        const LIFF_ID = "2009047186-VUUAVTF4";
        // é€™è£¡è¦å¡«å…¥æ‚¨ä¸»å·¥ä½œæµä¸­ã€Œæ–° Webhookã€çš„ Production URL
        const WEBHOOK_URL = "https://æ‚¨çš„n8nç¶²å€/webhook/liff-register"; 

        liff.init({ liffId: LIFF_ID }).catch(err => {
            alert("å•Ÿå‹•å¤±æ•—");
        });

    async function send() {
        const d = document.getElementById('date').value;
        const t = document.getElementById('time').value;
        const c = document.getElementById('city').value;
        const g = document.getElementById('gender').value;

        if (!d || !t || !c || !g) {
            alert("è«‹å®Œæ•´å¡«å¯«è³‡æ–™å–”ï¼");
            return;
        }

        const [hour, minute] = t.split(':');
        const h = parseInt(hour);
        const period = h >= 12 ? "ä¸‹åˆ (PM)" : "ä¸Šåˆ (AM)";
        const displayH = h > 12 ? h - 12 : (h === 0 ? 12 : h);
        const genderText = { "F": "å¥³æ€§", "M": "ç”·æ€§", "U": "ä¸é€éœ²/ä¸­æ€§" }[g];
    
        if (!confirm(`ç¢ºèªé€å‡ºè³‡æ–™å—ï¼Ÿ\næ—¥æœŸï¼š${d}\næ™‚é–“ï¼š${period} ${displayH}:${minute}\nåŸå¸‚ï¼š${c}\næ€§åˆ¥ï¼š${genderText}`)) {
            return;
        }

        try {
            // é—œéµä¿®æ”¹ 1ï¼šç²å–ä½¿ç”¨è€… userId
            const profile = await liff.getProfile();
            const userId = profile.userId;

            // é—œéµä¿®æ”¹ 2ï¼šé€é API å‚³é€è³‡æ–™çµ¦ n8n
            const response = await fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: userId,
                    date: d,
                    time: t,
                    city: c,
                    gender: g,
                    type: "api_registration" // æ¨™è¨»é€™æ˜¯å¾ API ä¾†çš„
                })
            });

            if (response.ok) {
                // æˆåŠŸå¾Œç›´æ¥é—œé–‰ï¼ŒèŠå¤©å®¤æœƒä¹¾ä¹¾æ·¨æ·¨
                liff.closeWindow();
            } else {
                alert("å‚³é€å¤±æ•—ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡");
            }
        } catch (err) {
            alert("éŒ¯èª¤: " + err.message);
        }
    }
    </script>
</body>
</html>
